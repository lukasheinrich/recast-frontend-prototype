{% extends "base.html" %}

{% block prebody %}
<script type="text/javascript">
$(document).ready(function(){
    $('#upload-response-btn').click(function(){
      console.log('this would be uploading the response')
    })

    $('.process-btn').click(function(){
        basicreqid = $(this).attr('data-basic-req-id')
        backend = $(this).attr('data-backend')
        url = location.origin+'/recast/processBasicRequest?basicreqid='+basicreqid+'&backend='+backend+'&analysisid='+{{analysis_info['id']}}
        $.ajax(url,{
            complete: function(data){
                var jobguid = data['responseJSON']['jobguid']
                console.log(data['responseJSON'])
                console.log('got jobguid: '+jobguid)
                window.location.assign(location.origin+'/monitor/' + jobguid)
            }
        })
    })

    $('.result-btn').each(function(){
        var button = $(this)

        backend = button.attr('data-backend')
        var basicReqId = button.attr('data-basic-req-id')
        var backend = button.attr('data-backend')
        var resultsAvailable = false

        var url = location.origin+'/status/'+basicReqId
        $.ajax(url,{
            async: false,
            complete: function(data){
                console.log(data['responseJSON'])
                console.log(data['responseJSON']['ready_backends'])
                console.log(backend)
                resultsAvailable = $.inArray(backend,data['responseJSON']['ready_backends']) >= 0
                console.log('results are available: '+ resultsAvailable)
                if(!resultsAvailable){
                  console.log('disabling button')
                  button.addClass('disabled')
                }
            }
        })
    })



    $('.results-group').each(function(){
        if(!$(this).children().filter('ul').children().filter(function(){return !$(this).hasClass('disabled')}).length){
            $(this).children().filter('button').addClass('disabled')
        }
    })

    {% if not session.has_key('user') or not backends %}
       $('.process-group button').addClass('disabled')
    {% endif %}


});

function togglejobs(basireqid){
  $('#basicreq_jobs_'+basireqid).toggleClass('hidden')
  if ($('#basicreq_jobs_2').hasClass('hidden')){
    $('#jobslabel_2').html('Show Processings')
  }
  else{
    $('#jobslabel_2').html('Hide Processings')
  }
}
</script>

{% endblock %}

{% block container%}
<div class="page-header">
    <h1>Recast Scan Request <small>{{request_info['title']}}</small></h1>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-primary">

            <div class="panel-heading">
                <h3 class="panel-title">Request Details</h3>
            </div>
            <div class="panel-body">
                  <span class="label label-default"><span class="glyphicon glyphicon-time" aria-hidden="true"></span> {{request_info['post_date']}}</span>
                  <h6>Analysis</h6>
                  <p>
                    {{analysis_info['title']}}
                  </p>
                  <h6>Reason:</h6>
                  <p>{{request_info['reason_for_request']}}</p>
                  <h6>Additional Info:</h6>
                  <p>{{request_info['additional_information']}}</p>
            </div>
        </div>
    </div> <!-- col -->
</div> <!-- row -->

<div class="row">
  <div class="col-md-12">
    <h3>Requested Parameter Points</h3>
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

      {% for i,pp in parpoints %}

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading_{{loop.index}}">
          <h4 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse_{{loop.index}}" aria-expanded="true" aria-controls="collapse_{{loop.index}}">
              Parameter Point {{loop.index}}
            </a>
          </h4>
        </div>
        <div id="collapse_{{loop.index}}" class="panel-collapse collapse {{'%s' % 'in' if loop.index == 1}}" role="tabpanel" aria-labelledby="heading_{{loop.index}}">
          <div class="panel-body">
            {% if basic_req_data[pp['id']] %}
            <ul class="list-group">
              {% for br in basic_req_data[pp['id']] %}
                <li class="list-group-item">
                    <strong>Basic Request {{loop.index}}: </strong>
                    <!-- The UI buttons -->
                    <span>
                    <!-- Single button -->
                    <div class="btn-group process-group">
                      <button type="button" class="btn btn-primary btn-xs dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                        Process <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu" role="menu">
                      {% for b in backends %}
                        <li><a href="#" class="btn btn-xs process-btn" data-basic-req-id="{{br['id']}}" data-backend="{{b}}">{{b}}</a></li>
                      {% endfor %}
                      </ul>
                    </div>
                    <button id="upload-response-btn"type="button" class="btn btn-primary btn-xs" aria-label="Left Align" onclick="togglejobs({{br['id']}})">
                      <span class="glyphicon glyphicon-tasks" aria-hidden="true" style="margin-right:1em"></span><span id="jobslabel_{{br['id']}}">Show Processings</span>
                    </button>
                    <!-- Single button -->
                    <div class="btn-group results-group">
                      <button type="button" class="btn btn-primary btn-xs dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                        Results <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu" role="menu">
                      {% for b in backends %}
                        <li><a href="/resultview/{{br['id']}}/{{b}}" class="btn btn-xs result-btn" data-basic-req-id="{{br['id']}}" data-backend="{{b}}">{{b}}</a></li>
                      {% endfor %}
                      </ul>
                    </div>
                    <button id="upload-response-btn"type="button" class="btn btn-primary btn-xs" aria-label="Left Align">
                      <span class="glyphicon glyphicon-upload" aria-hidden="true" style="margin-right:1em"></span><span>Upload to RECAST</span>
                    </button>
                  </span>
                  <div id="basicreq_jobs_{{br['id']}}" class="hidden">
                    <h6>Backend Information:</h6>

                    {%
                      set state_map = {'SUCCESS':['ok','success'],'FAILURE':['remove','danger'],'PENDING':['hourglass','active'],'STARTED':['cog','info']}
                    %}

                    {% for jobdata in processing_info[br['id']] %}
                      <div>
                        <span style="font-family:monospace;">{{jobdata['job']}}</a></span>
                        <span class="label label-{{state_map[jobdata['celery']][1]}}"><span class="glyphicon glyphicon-{{state_map[jobdata['celery']][0]}}" aria-hidden="true"></span></span>
                        <a href="/monitor/{{jobdata['job']}}"><span class="label label-default"><span class="glyphicon glyphicon-console" aria-hidden="true"></span> Logs</a></span></a>
                      </div>
                    {% endfor %}

                  </div>
                </li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>
        </div>
      </div>

      {% endfor %}
    </div>
  </div>


  <div class="col-md-12">
    <ul class="list-group">
    {% for i,pp in parpoints %}
        <li class="list-group-item">
          <h6>Parameter Point {{pp['id']}}</h6>
        </li>
    {% endfor %}
  </ul>
  </div>
</div>



<div id="upload-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
           <h4 class="modal-title">Success</h4>
      </div>
      <div class="modal-body">
          Uploaded latest result file to RECAST server.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

{% endblock %}
